# 发布流程

本文档概述了 WuKong Easy SDK 的完整发布流程，包括版本管理、测试和分发程序。

## 版本编号策略

### 语义版本控制 (SemVer)

我们遵循 [语义版本控制 2.0.0](https://semver.org/) 格式 `主版本.次版本.修订版本`：

- **主版本** (X.0.0): 需要用户代码修改的破坏性变更
- **次版本** (0.X.0): 向后兼容的新功能
- **修订版本** (0.0.X): 错误修复和小改进

### 版本示例

```
1.0.0    - 初始稳定版本
1.0.1    - 错误修复版本
1.1.0    - 新功能版本（向后兼容）
2.0.0    - 破坏性变更版本
```

### 预发布版本

用于开发和测试：
```
1.1.0-alpha.1    - Alpha 版本
1.1.0-beta.1     - Beta 版本
1.1.0-rc.1       - 候选版本
```

## 发布工作流

### 1. 规划阶段

**发布规划会议**
- [ ] 定义发布范围和时间表
- [ ] 审查功能请求和错误报告
- [ ] 分配开发任务
- [ ] 设定发布日期目标

**文档要求**
- [ ] 为新功能更新 API 文档
- [ ] 为破坏性变更准备迁移指南
- [ ] 更新示例应用程序
- [ ] 审查和更新 README 文件

### 2. 开发阶段

**功能开发**
```bash
# 创建功能分支
git checkout -b feature/new-feature-name
git push -u origin feature/new-feature-name

# 开发工作...
# 使用约定式提交消息定期提交

# 准备就绪时创建拉取请求
```

**代码审查流程**
- [ ] 所有代码变更由至少一名维护者审查
- [ ] 自动化测试通过
- [ ] 文档已更新
- [ ] 破坏性变更已记录

### 3. 预发布测试

**自动化测试**
```bash
# 运行完整测试套件
flutter test --coverage

# 静态分析
flutter analyze

# 格式检查
dart format --set-exit-if-changed .

# 示例应用测试
cd example
flutter test
flutter build apk --debug  # Android
flutter build ios --debug  # iOS (在 macOS 上)
flutter build web          # Web
cd ..
```

**手动测试检查清单**
- [ ] 示例应用在所有支持平台上运行
- [ ] 连接和重连场景
- [ ] 消息发送和接收
- [ ] 错误处理和边缘情况
- [ ] 负载下的性能
- [ ] 内存泄漏测试

**平台测试矩阵**

| 平台 | 版本 | 状态 |
|------|------|------|
| Android | 5.0+ (API 21+) | ✅ |
| iOS | 11.0+ | ✅ |
| Web | 现代浏览器 | ✅ |
| macOS | 10.14+ | ✅ |
| Windows | 10+ | ✅ |
| Linux | 现代发行版 | ✅ |

### 4. 发布准备

**版本更新**
```bash
# 在 pubspec.yaml 中更新版本
# 如需要，在 example/pubspec.yaml 中更新版本
# 在文档中更新版本引用
```

**更新日志更新**
```markdown
## [1.1.0] - 2024-01-XX

### 新增
- 新功能：实时输入指示器
- 支持消息反应
- 增强错误报告

### 变更
- 改进重连算法
- 将依赖项更新到最新版本

### 弃用
- 旧连接方法（将在 v2.0.0 中移除）

### 移除
- 传统基于回调的 API

### 修复
- 事件监听器中的内存泄漏
- 慢网络上的连接超时

### 安全
- 增强令牌验证
- 改进 WebSocket 安全性
```

**文档更新**
- [ ] 使用新功能更新 README.md
- [ ] 更新 README.zh-CN.md（中文版本）
- [ ] 更新 API 文档
- [ ] 更新示例代码
- [ ] 审查迁移指南

### 5. 发布创建

**Git 标签**
```bash
# 确保所有更改已提交
git add .
git commit -m "chore: prepare for v1.1.0 release"

# 创建带注释的标签
git tag -a v1.1.0 -m "Release v1.1.0

- 新功能：实时输入指示器
- 支持消息反应
- 增强错误报告
- 错误修复和性能改进"

# 推送更改和标签
git push origin main
git push origin v1.1.0
```

**GitHub 发布**
1. 转到 GitHub 仓库 → Releases
2. 点击 "Create a new release"
3. 选择标签 `v1.1.0`
4. 发布标题：`v1.1.0 - 功能发布`
5. 复制更新日志内容作为描述
6. 如适用，标记为预发布
7. 发布版本

### 6. 包发布

**试运行验证**
```bash
# 发布前验证包
dart pub publish --dry-run

# 检查警告或错误
# 验证包内容
```

**发布**
```bash
# 发布到 pub.dev
dart pub publish

# 验证发布
# 检查 pub.dev 上的包页面
```

### 7. 发布后活动

**验证**
- [ ] 包出现在 pub.dev 上
- [ ] 文档正确渲染
- [ ] 在测试项目中安装工作正常
- [ ] 所有平台都可以安装和使用包

**沟通**
- [ ] 在 GitHub Discussions 中宣布发布
- [ ] 更新项目文档
- [ ] 通知依赖项目
- [ ] 社交媒体公告（如适用）

**监控**
- [ ] 监控安装问题
- [ ] 关注错误报告
- [ ] 跟踪下载统计
- [ ] 监控社区反馈

## 热修复流程

对于需要立即发布的关键错误：

### 1. 热修复分支
```bash
# 从 main 创建热修复分支
git checkout main
git pull origin main
git checkout -b hotfix/v1.0.1

# 进行最小修复
# 彻底测试
# 更新版本到 1.0.1
# 更新更新日志
```

### 2. 快速发布
```bash
# 提交修复
git add .
git commit -m "fix: critical bug in connection handling"

# 创建标签
git tag -a v1.0.1 -m "Hotfix v1.0.1 - 关键错误修复"

# 合并回 main
git checkout main
git merge hotfix/v1.0.1

# 推送所有内容
git push origin main
git push origin v1.0.1

# 立即发布
dart pub publish
```

## 发布计划

### 定期发布
- **主要发布**：每 6-12 个月
- **次要发布**：每 1-3 个月
- **修补发布**：根据错误修复需要

### 发布日历
- **规划**：月初第一周
- **开发**：第 2-3 周
- **测试**：第 4 周
- **发布**：下个月第一周

## 质量门控

### 自动化检查
- [ ] 所有单元测试通过
- [ ] 集成测试通过
- [ ] 静态分析清洁
- [ ] 代码覆盖率 > 80%
- [ ] 无安全漏洞

### 手动检查
- [ ] 示例应用在所有平台上工作
- [ ] 文档准确
- [ ] 破坏性变更已记录
- [ ] 迁移指南完整

### 性能基准
- [ ] 连接时间 < 2 秒
- [ ] 消息延迟 < 100ms
- [ ] 内存使用稳定
- [ ] 未检测到内存泄漏

## 回滚程序

### 立即回滚
```bash
# 撤回有问题的版本（7天内）
dart pub retract 1.1.0

# 向用户传达问题
# 准备修复版本
```

### 版本弃用
```bash
# 将版本标记为停用
dart pub discontinue 1.1.0

# 提供迁移路径
# 更新文档
```

## 工具和自动化

### 必需工具
- Flutter SDK（最新稳定版）
- Dart SDK（最新稳定版）
- Git
- pub CLI 工具

### 推荐工具
- 用于发布自动化的 GitHub CLI
- Flutter/Dart IDE 插件
- 代码覆盖率工具
- 性能分析工具

### 未来自动化
- 用于 CI/CD 的 GitHub Actions
- 多平台自动化测试
- 自动化更新日志生成
- 依赖项更新自动化

## 紧急程序

### 关键安全问题
1. **立即响应**（24小时内）
   - 评估严重性和影响
   - 准备安全补丁
   - 与安全团队协调

2. **补丁发布**（48小时内）
   - 创建热修复分支
   - 实施最小修复
   - 快速测试和发布

3. **沟通**
   - GitHub 上的安全公告
   - 更新文档
   - 直接通知主要用户

### 破坏生产的问题
1. **评估**
   - 识别受影响的版本
   - 确定影响范围
   - 优先修复开发

2. **响应**
   - 如可能，撤回有问题的版本
   - 提供解决方案指导
   - 加速修复开发

3. **解决**
   - 发布补丁版本
   - 更新文档
   - 事后分析
